<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map_canvas { height: 100% }
    </style>
    <script type="text/javascript"
      src="http://maps.googleapis.com/maps/api/js?&sensor=false">
    </script>
    <script type="text/javascript">
	lat_lng = new Array();
	lat_lng_out = new Array();
	var l = 0;
	var map;
	var fin = false;
	var wspolrzedne = new google.maps.LatLng(54.07232,18.76756320000004);
	var wspolrzedne2 = new google.maps.LatLng(54.073,18.76756320000004);
	//var wspolrzedne3 = new google.maps.LatLng(54.075,18.76756320000004);
			var paths = [];
		paths.push(new google.maps.LatLng(54.07232,18.76756320000004));
		paths.push(new google.maps.LatLng(54.073,18.7675632000000));
		paths.push(new google.maps.LatLng(54.075,18.76756320000004));
	  document.onreadystatechange = function() {
  if (document.readyState === 'complete') {
    fn();
  }
};
function fn()
{
	document.getElementById('file').onchange = function(){

		var file = this.files[0];

		var reader = new FileReader();
		reader.readAsText(file, 'ISO-8859-1');
		reader.onload = function(progressEvent){
			console.log(this.result);
			var lines = this.result.split('\n');
			for(var line = 0; line < lines.length; line++){
				console.log(lines[line]);
				console.log(line);
			}
			console.log("skonczylem");
			fin = true;
			dodajMarkerSnap(paths,rysuj_time);
		};
	  reader.readAsText(file);
	};
}
	
	
	
	
	function markers(_callback)
	{
		dodajMarkerSnap(wspolrzedne);
		dodajMarkerSnap(wspolrzedne2);
		_callback();
	}
	
	function dodajMarker(lat,lon,opcjeMarkera)
			{
				// tworzymy marker z współrzędnymi i opcjami z argumentów funkcji dodajMarker
				opcjeMarkera.position = new google.maps.LatLng(lat,lon);
				
				opcjeMarkera.map = map; // obiekt mapa jest obiektem globalnym!
				var marker = new google.maps.Marker(opcjeMarkera);
			}
	function dodajMarkerSnap(wspolrzedne, _callback)
	{
	var aaa = false;
	console.log(aaa);
	for (var i = 0; i < wspolrzedne.length; i++) 
	{
		console.log(aaa);
		var directionsServiceSnap = new google.maps.DirectionsService();
		var requestSnap = {
			origin:wspolrzedne[i], 
			destination:wspolrzedne[i],
			travelMode: google.maps.DirectionsTravelMode.DRIVING
		};
		directionsServiceSnap.route(requestSnap, function(response, status) {
		if (status == google.maps.DirectionsStatus.OK) {
			 var marker = new google.maps.Marker({
             position: response.routes[0].legs[0].start_location, 
             map: map,
             title:"Hello World!"
			});
			var lat = marker.getPosition().lat();
			var lng = marker.getPosition().lng();
			console.log(lat);
			console.log(lng);
			var myLatlng = new google.maps.LatLng(lat,lng);
            lat_lng.push(myLatlng);
			console.log(lat_lng.length);
			console.log(aaa);
		}
		});
		if (i === (wspolrzedne.length - 1))
			aaa = true;
	}
		if (aaa)
			_callback();
	}
	function rysuj_time()
	{
		var myVar = setTimeout(rysuj, 3000);
	}
	function rysuj()
	{	
		   console.log("wchodze w rysuj");
	       var path = new google.maps.MVCArray();
           var service = new google.maps.DirectionsService();
           var infoWindow = new google.maps.InfoWindow();
           var poly = new google.maps.Polyline({ map: map, strokeColor: '#FF8200' });
		   console.log(lat_lng.length);
           for (var i = 0; i < lat_lng.length; ++i) {
		   console.log(i);
               if ((i + 1) < lat_lng.length) {
                   var src = lat_lng[i];
                   var des = lat_lng[i + 1];
                   path.push(src);
                   poly.setPath(path);
                   service.route({
                       origin: src,
                       destination: des,
                       travelMode: google.maps.DirectionsTravelMode.DRIVING
                   }, function (result, status) {
                       if (status == google.maps.DirectionsStatus.OK) {
                           for (var j = 0, len = result.routes[0].overview_path.length; j < len; j++) {
                               path.push(result.routes[0].overview_path[j]);
                           }
                       }
                   });
               }
           }
		   console.log("wychodze z rysuj");
	}
      function initialize() {
        var myOptions = {
          center: new google.maps.LatLng(54.0924200,18.7778700),
          zoom: 13,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
		  disableDefaultUI: true
        };

		//setTimeout(dodajMarkerSnap(wspolrzedne), 10);
		//setTimeout(dodajMarkerSnap(wspolrzedne2), 20);
		//setTimeout(rysuj, 300);
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
}
    </script> 
  </head>
  <body onload="initialize()">
    <div id="map_canvas" style="width:100%; height:100%"></div>
	<div><input type="file" name="file" id="file"></div>
  </body>
</html>