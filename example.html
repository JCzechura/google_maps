<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style type="text/css">
    </style>
	<link rel="Stylesheet" type="text/css" href="style.css" />
    <script type="text/javascript"
      src="http://maps.googleapis.com/maps/api/js?&sensor=false">
    </script>
    <script type="text/javascript">
	lat_lng = new Array();
	markers_out= [];
	var l = 0;
	var map;
	var gps_correct = true;
	var NS_arr = [];
	var WE_arr = [];
	var titles = [];
	var IDcodes = [];
	var BaseIDCodes = [];
	var BaseAddresses = [];
	var BaseLat = [];
	var BaseLng = [];
	var first_line = false;
	
	document.onreadystatechange = function() {
  if (document.readyState === 'complete') {
    fn();
	fn2();
  }
};
function fn()
{
	document.getElementById('file').onchange = function()
	{
		var file = this.files[0];
		var reader = new FileReader();
		var address = "";
		reader.readAsText(file, 'ISO-8859-1');
		reader.onload = function(progressEvent)
		{
			console.log(this.result);
			var lines = this.result.split('\n');
			var title1 = "";
			for(var line = 0; line < lines.length; line++)
			{
				var res = lines[line].split('#'); 
				if (res.length == 6)
				{
					console.log("res = 6");
					if  (res[3].length>4)
						{
							for(var i = 0; i < BaseIDCodes.length; i++)
							{
								if (res[3].trim() == BaseIDCodes[i].trim())
								{
									address = BaseAddresses[i];
									IDcodes.push(res[3]);
									var markerl = new google.maps.Marker({
										position: new google.maps.LatLng(BaseLat[i], BaseLng[i]),
										map: map,
										visible: true,
										icon: 'trash11.png',
										title:address
									});
								}
							}	
						}
					
				}else if (res.length > 6)
				{                                          // TUTAJ DOPISAC JESCZE OBSLUGE BŁĘDBYCH DANYCH czyli ostatniego res == 0, ze zmienną gps_correct !!!!!!!!!!!!!!!!!!!
					if ((res[3] == "N") & (res[6] == "E"))
					{
						var NS1 = parseFloat(res[1]) + parseFloat(res[2])/60;
						var WE1 = parseFloat(res[4]) + parseFloat(res[5])/60;
						if 	(( 49.14578361775004 < NS1 ) && (NS1 < 54.92082843149136 ) && ( 14.6337890625 < WE1) && (WE1 < 24.2578125 ))
						{
							console.log("NIE WYSZEDLEM POZA GRANICE POLSKI");
							console.log(NS1);
							console.log(WE1);
							console.log(first_line);
							if (first_line == false)
							{
								first_line = true;
								if  (res[7].length>4)
								{
									IDcodes.push(res[7]);
									if (res[0].split(':').length == 3)
										title1 = res[0] + " - " +  res[7];
									else
										title1 = res[7];
								}else if (res[0].split(':').length == 3)
									title1 = res[0];
								else title1 = "";
								console.log(title1);
								titles.push(title1);
								NS_arr.push(NS1);
								WE_arr.push(WE1);
								//paths.push(new google.maps.LatLng(NS1,WE1));
								var markerl = new google.maps.Marker({
									position: new google.maps.LatLng(NS1,WE1),
									map: map,
									visible: true,
									icon: 'green_button.png',
									title:title1
								});
								if (res[7] != "1")
									markerl.setIcon('trash11.png');
								if (res[7] == "!!!")
									markerl.setIcon('landfill1.png');
								markers_out.push(markerl);
							}
							else
							{
								var lat = NS_arr[NS_arr.length - 1];
								var lng = WE_arr[WE_arr.length - 1];
								console.log(lat);
								console.log(lng);
								if ((Math.abs(lat - NS1) > 0.0003)  || (Math.abs(lng - WE1) > 0.0005) || res[7] != "1" || res[7] == "!!!")
								{
									
									if  (res[7].length>4)
									{
										for(var i = 0; i < BaseIDCodes.length; i++)
										{
											if (res[7].trim() == BaseIDCodes[i].trim())
												address = BaseAddresses[i];
										}
										IDcodes.push(res[7]);
										if (res[0].split(':').length == 3)
											title1 = res[0] + " - " + address;
										else
											title1 = address;
									}else if (res[0].split(':').length == 3)
										title1 = res[0];
									else title1 = "";
										console.log(title1);
										titles.push(title1);
										NS_arr.push(NS1);
										WE_arr.push(WE1);
										//paths.push(new google.maps.LatLng(NS1,WE1));
										var markerl = new google.maps.Marker({
											position: new google.maps.LatLng(NS1,WE1),
											map: map,
											visible: true,
											icon: 'green_button.png',
											title:title1
										});
										if (res[7] != "1")
											markerl.setIcon('trash11.png');
										if (res[7] == "!!!")
											markerl.setIcon('landfill1.png');
										markers_out.push(markerl);
								}
							}
						}else if  (res[7].length>4)
						{
							for(var i = 0; i < BaseIDCodes.length; i++)
							{
								if (res[7].trim() == BaseIDCodes[i].trim())
								{
									address = BaseAddresses[i];
									IDcodes.push(res[7]);
									if (res[0].split(':').length == 3)
										title1 = res[0] + " - " + address;
									else
										title1 = address;
									var markerl = new google.maps.Marker({
										position: new google.maps.LatLng(BaseLat[i], BaseLng[i]),
										map: map,
										visible: true,
										icon: 'trash11.png',
										title:title1
									});
								}
							}	
						}
					} else if  (res[7].length>4)
						{
							for(var i = 0; i < BaseIDCodes.length; i++)
							{
								if (res[7].trim() == BaseIDCodes[i].trim())
								{
									address = BaseAddresses[i];
									IDcodes.push(res[7]);
									if (res[0].split(':').length == 3)
										title1 = res[0] + " - " + address;
									else
										title1 = address;
									var markerl = new google.maps.Marker({
										position: new google.maps.LatLng(BaseLat[i], BaseLng[i]),
										map: map,
										visible: true,
										icon: 'trash11.png',
										title:title1
									});
								}
							}	
						}
				}
			}
			console.log("skonczylem");
			console.log(BaseIDCodes);
			console.log(IDcodes);
							var checked_counter = 0;
				var not_checked_counter = 0;
			for(var i = 0; i < BaseIDCodes.length; i++)
			{
				var IDChecked = false;
				for(var j = 0; j < IDcodes.length; j++)
				{
				console.log("BaseIDCodes[i]");
				console.log(BaseIDCodes[i]);
				console.log("IDcodes[j]");
				console.log(IDcodes[j]);
					if (IDcodes[j].trim() == BaseIDCodes[i].trim())
						IDChecked = true;
				console.log(IDChecked);
				}
				console.log(IDChecked);
				console.log(IDChecked);
				console.log(IDChecked);
				if (IDChecked == false)
				{
					not_checked_counter++;
					var markerl = new google.maps.Marker({
						position: new google.maps.LatLng(BaseLat[i], BaseLng[i]),
						map: map,
						visible: true,
						icon: 'trash_red.png',
						title:BaseAddresses[i]
					});
					var text1 = document.getElementById('txt1');
					if (not_checked_counter == 1)
						text1.value=not_checked_counter + ". "+ BaseAddresses[i] +" - "+ BaseLat[i] +" N, "+ BaseLng[i] +" E"+ "\n";
					else
						text1.value+=not_checked_counter + ". "+ BaseAddresses[i] +" - "+ BaseLat[i] +" N, "+ BaseLng[i] +" E"+ "\n";	
				}
				else
				{
					checked_counter++;
					console.log(checked_counter);
					var text2 = document.getElementById('txt2');
					if (checked_counter == 1)
						text2.value=checked_counter+". "+ BaseAddresses[i] +" - "+ BaseLat[i] +" N, "+ BaseLng[i] +" E"+ "\n";
					else
						text2.value+=checked_counter+". "+ BaseAddresses[i] +" - "+ BaseLat[i] +" N, "+ BaseLng[i] +" E"+ "\n";
				
				}
			}
			console.log("skonczylem całkiem");
			var deb = "12345671234567222";
			console.log(parseFloat(deb));
			console.log(parseFloat(BaseIDCodes[3]));
			   var domain, number, pieces;

    domain =BaseIDCodes[3];
    number = 13;
    pieces = [domain.substring(number, -number), domain.substring(number)];

    console.log(pieces);
	 console.log(parseFloat(pieces[0]));
	  console.log(parseFloat(pieces[1]));
		};
	};
}
function fn2()
{
	document.getElementById('file1').onchange = function()
	{	
		var file = this.files[0];
		var reader = new FileReader();
		reader.readAsText(file, 'ISO-8859-1');
		reader.onload = function(progressEvent)
		{
			console.log(this.result);
			var lines = this.result.split('\n');
			for(var line = 0; line < lines.length; line++)
			{
				console.log(lines[line]);
				console.log(line);
				var res = lines[line].split('#'); 
				BaseIDCodes.push(res[0]);
				BaseAddresses.push(res[1]);
				BaseLat.push(res[2]);	
				BaseLng.push(res[3]);	
			}
		}
	
	};
}
	
	function markers(_callback)
	{
		dodajMarkerSnap(wspolrzedne);
		dodajMarkerSnap(wspolrzedne2);
		_callback();
	}
	
	function dodajMarker(lat,lon,opcjeMarkera)
			{
				opcjeMarkera.position = new google.maps.LatLng(lat,lon);
				
				opcjeMarkera.map = map;
				var marker = new google.maps.Marker(opcjeMarkera);
			}
	function title_time()
	{
		console.log("zara nowy tytex");
		var myVar = setTimeout(title, 10000);
	}
	function title()
	{
	console.log("zmieniam tyt");
		markers_out[markers_out.length-1].setTitle("new title");
		 console.log("nowy tytex");
	}
      function initialize() {
        var myOptions = {
          center: new google.maps.LatLng(54.0924200,18.7778700),
          zoom: 13,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
		  disableDefaultUI: false
        };
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		 google.maps.event.addListener(map, 'click', function(event) {
   console.log("Latitude: " + event.latLng.lat() + " " + ", longitude: " + event.latLng.lng());
   
  });
}
    </script> 
  </head>
  <body padding = 2cm 4cm 3cm 4cm background="ccc.png" onload="initialize()">
  <h1>System wspomagania monitoringu gospodarki odpadami komunalnymi</h1>
  <div id="rodzic">
    <div id="map_canvas" style="width:60%; height:95%">
	</div>
		<div id="filef">
			<label for="file1" class="custom-file-upload">
				<i class="fa fa-cloud-upload"></i>1. Załaduj plik z adresami i kodami poszczególnych pojemników
			</label>
			<input id="file1" type="file"/>
			<br></br>
			<label for="file" class="custom-file-upload">
				<i class="fa fa-cloud-upload"></i> 2. Załaduj plik z trasą przebytą przez pojazd
			</label>
			<input id="file" type="file"/>
		</div>
		<div id="textboxes">
			<div id="list">
				<p id="checked">POJEMNIKI NIEOBSŁUŻONE</p>
				<output type="text" id="txt1"/>
				</div>
			<div id="list">
				<p id="not_checked">POJEMNIKI OBSŁUŻONE</p>
				<output type="text" id="txt2"/>
			</div>
		</div>
   </div>
  </body>
</html>